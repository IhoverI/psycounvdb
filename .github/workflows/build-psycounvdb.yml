---
name: Build psycounvdb packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: false
        default: '2.9.11'

env:
  PIP_BREAK_SYSTEM_PACKAGES: "1"
  LIBPQ_VERSION: "17.6"
  OPENSSL_VERSION: "3.5.4"
  PACKAGE_NAME: "psycounvdb"
  VERSION: "2.9.11"

jobs:
  linux-x86_64:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313, cp314]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-x86_64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_x86_64
          CIBW_ARCHS_LINUX: x86_64
          CIBW_PRERELEASE_PYTHONS: "1"
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  linux-aarch64:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313, cp314]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-arch build
        uses: docker/setup-qemu-action@v3

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-aarch64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_aarch64
          CIBW_ARCHS_LINUX: aarch64
          CIBW_PRERELEASE_PYTHONS: "1"
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"

      - uses: actions/upload-artifact@v4
        with:
          name: linux-aarch64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  macos-x86_64:
    runs-on: macos-13
    strategy:
      fail-fast: false
      matrix:
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313, cp314]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-macos-x86_64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        env:
          CIBW_BUILD: ${{matrix.pyver}}-macosx_x86_64
          CIBW_ARCHS_MACOS: x86_64
          CIBW_PRERELEASE_PYTHONS: "1"
          MACOSX_ARCHITECTURE: x86_64
          CIBW_BEFORE_ALL_MACOS: ./scripts/build/wheel_macos_before_all.sh
          CIBW_ENVIRONMENT: >-
            PG_VERSION=16
            PACKAGE_NAME=psycounvdb
            PATH="/tmp/libpq.build/bin:$PATH"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  macos-arm64:
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313, cp314]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-macos-arm64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        env:
          CIBW_BUILD: ${{matrix.pyver}}-macosx_arm64
          CIBW_ARCHS_MACOS: arm64
          CIBW_PRERELEASE_PYTHONS: "1"
          MACOSX_ARCHITECTURE: arm64
          CIBW_BEFORE_ALL_MACOS: ./scripts/build/wheel_macos_before_all.sh
          CIBW_ENVIRONMENT: >-
            PG_VERSION=16
            PACKAGE_NAME=psycounvdb
            PATH="/tmp/libpq.build/bin:$PATH"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  windows-amd64:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313, cp314]

    defaults:
      run:
        shell: bash

    steps:
      - name: Drop spurious libpq in the path
        run: rm -rf c:/tools/php C:/Strawberry/c/bin

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            const path = require('path')
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
            core.addPath(path.join(process.env.VCPKG_INSTALLATION_ROOT, 'installed/x64-windows-release/lib'));
            core.addPath(path.join(process.env.VCPKG_INSTALLATION_ROOT, 'installed/x64-windows-release/bin'));

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
          CIBW_BUILD: ${{matrix.pyver}}-win_amd64
          CIBW_ARCHS_WINDOWS: AMD64
          CIBW_PRERELEASE_PYTHONS: "1"
          CIBW_BEFORE_BUILD_WINDOWS: '.\scripts\build\wheel_win32_before_build.bat'
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: >-
            delvewheel repair -w {dest_dir}
            --no-mangle "libiconv-2.dll;libwinpthread-1.dll" {wheel}
          CIBW_ENVIRONMENT_WINDOWS: >-
            PACKAGE_NAME=psycounvdb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  # 打包各平台的所有 Python 版本到一个 zip
  package:
    runs-on: ubuntu-latest
    needs:
      - linux-x86_64
      - linux-aarch64
      - macos-x86_64
      - macos-arm64
      - windows-amd64

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package by platform
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p dist
          
          # Linux x86_64
          mkdir -p pkg/linux-x86_64
          cp artifacts/linux-x86_64-*/*.whl pkg/linux-x86_64/
          cd pkg/linux-x86_64 && zip -r "../../dist/psycounvdb-${VERSION}-linux-x86_64-python3.8~3.14.zip" *.whl && cd ../..
          
          # Linux aarch64
          mkdir -p pkg/linux-aarch64
          cp artifacts/linux-aarch64-*/*.whl pkg/linux-aarch64/
          cd pkg/linux-aarch64 && zip -r "../../dist/psycounvdb-${VERSION}-linux-aarch64-python3.8~3.14.zip" *.whl && cd ../..
          
          # macOS x86_64
          mkdir -p pkg/macos-x86_64
          cp artifacts/macos-x86_64-*/*.whl pkg/macos-x86_64/
          cd pkg/macos-x86_64 && zip -r "../../dist/psycounvdb-${VERSION}-macos-x86_64-python3.8~3.14.zip" *.whl && cd ../..
          
          # macOS arm64
          mkdir -p pkg/macos-arm64
          cp artifacts/macos-arm64-*/*.whl pkg/macos-arm64/
          cd pkg/macos-arm64 && zip -r "../../dist/psycounvdb-${VERSION}-macos-arm64-python3.8~3.14.zip" *.whl && cd ../..
          
          # Windows amd64
          mkdir -p pkg/windows-amd64
          cp artifacts/windows-amd64-*/*.whl pkg/windows-amd64/
          cd pkg/windows-amd64 && zip -r "../../dist/psycounvdb-${VERSION}-windows-amd64-python3.8~3.14.zip" *.whl && cd ../..
          
          # 列出生成的包
          echo "Generated packages:"
          ls -la dist/

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: psycounvdb-all-platforms
          path: dist/*.zip
