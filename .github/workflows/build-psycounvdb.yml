---
name: Build psycounvdb packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: false
        default: '2.9.11'

env:
  PIP_BREAK_SYSTEM_PACKAGES: "1"
  LIBPQ_VERSION: "17.6"
  OPENSSL_VERSION: "3.5.4"
  PACKAGE_NAME: "psycounvdb"
  VERSION: "2.9.11"

jobs:
  # manylinux_2_28 (CentOS 8+, glibc 2.28)
  linux-x86_64:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-x86_64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}-manylinux_2_28

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_x86_64
          CIBW_ARCHS_LINUX: x86_64
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28

      - uses: actions/upload-artifact@v6
        with:
          name: linux-x86_64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  linux-aarch64:
    runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-aarch64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}-manylinux_2_28

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_aarch64
          CIBW_ARCHS_LINUX: aarch64
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28

      - uses: actions/upload-artifact@v6
        with:
          name: linux-aarch64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  # manylinux2014 (CentOS 7, glibc 2.17)
  # Note: Python 3.13 requires glibc 2.28+, so not supported on manylinux2014
  linux-x86_64-legacy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-x86_64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}-manylinux2014

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_x86_64
          CIBW_ARCHS_LINUX: x86_64
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014

      - uses: actions/upload-artifact@v6
        with:
          name: linux-x86_64-legacy-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  linux-aarch64-legacy:
    runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-aarch64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}-manylinux2014

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_aarch64
          CIBW_ARCHS_LINUX: aarch64
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux2014

      - uses: actions/upload-artifact@v6
        with:
          name: linux-aarch64-legacy-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  windows-amd64:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313]

    defaults:
      run:
        shell: bash

    steps:
      - name: Drop spurious libpq in the path
        run: rm -rf c:/tools/php C:/Strawberry/c/bin

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            const path = require('path')
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
            core.addPath(path.join(process.env.VCPKG_INSTALLATION_ROOT, 'installed/x64-windows-release/lib'));
            core.addPath(path.join(process.env.VCPKG_INSTALLATION_ROOT, 'installed/x64-windows-release/bin'));

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_INSTALLATION_ROOT }}/installed
            ${{ env.VCPKG_INSTALLATION_ROOT }}/packages
          key: vcpkg-windows-x64-libpq-openssl-v1

      - name: Install vcpkg packages (once for all Python versions)
        shell: cmd
        run: |
          echo "=== Installing vcpkg packages ==="
          vcpkg install libpq:x64-windows-release openssl:x64-windows-release
          echo "=== Checking vcpkg installed files ==="
          dir "%VCPKG_INSTALLATION_ROOT%\installed\x64-windows-release\lib\*pq*"
          dir "%VCPKG_INSTALLATION_ROOT%\installed\x64-windows-release\bin\*.dll"

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
          CIBW_BUILD: ${{matrix.pyver}}-win_amd64
          CIBW_ARCHS_WINDOWS: AMD64
          CIBW_BEFORE_BUILD_WINDOWS: '.\scripts\build\wheel_win32_before_build.bat'
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: 'copy /Y "{wheel}" "{dest_dir}\\"'
          CIBW_ENVIRONMENT_PASS_WINDOWS: >-
            VCPKG_INSTALLATION_ROOT
            VCPKG_BINARY_SOURCES
            ACTIONS_CACHE_URL
            ACTIONS_RUNTIME_TOKEN
          CIBW_ENVIRONMENT_WINDOWS: >-
            PACKAGE_NAME=psycounvdb
            PIP_NO_BUILD_ISOLATION=1

      - uses: actions/upload-artifact@v6
        with:
          name: windows-amd64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

      - name: Upload vcpkg DLLs (only once from first job)
        if: matrix.pyver == 'cp38'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path vcpkg_dlls
          $vcpkgBin = "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows-release\bin"
          Write-Host "Looking for DLLs in: $vcpkgBin"
          
          # Copy required DLLs (libpq and openssl dependencies)
          $requiredDlls = @(
            "libpq.dll",
            "libssl-3-x64.dll",
            "libcrypto-3-x64.dll",
            "libiconv-2.dll",
            "libintl-9.dll"
          )
          
          foreach ($dll in $requiredDlls) {
            $src = Join-Path $vcpkgBin $dll
            if (Test-Path $src) {
              Copy-Item $src vcpkg_dlls/
              Write-Host "Copied: $dll"
            } else {
              Write-Host "Not found: $dll"
            }
          }
          
          # Also copy any other DLLs that might be needed
          Get-ChildItem "$vcpkgBin\*.dll" | ForEach-Object {
            if (-not (Test-Path "vcpkg_dlls\$($_.Name)")) {
              Copy-Item $_.FullName vcpkg_dlls/
              Write-Host "Copied additional: $($_.Name)"
            }
          }
          
          Write-Host ""
          Write-Host "DLLs collected from vcpkg:"
          Get-ChildItem vcpkg_dlls

      - uses: actions/upload-artifact@v6
        if: matrix.pyver == 'cp38'
        with:
          name: windows-vcpkg-dlls
          path: vcpkg_dlls/
          if-no-files-found: error

  package:
    runs-on: ubuntu-latest
    needs:
      - linux-x86_64
      - linux-aarch64
      - linux-x86_64-legacy
      - linux-aarch64-legacy
      - windows-amd64

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install patchelf
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf

      - name: Package by platform
        run: |
          VERSION="${{ env.VERSION }}"
          PSYCOPG2_BINARY_VERSION="2.9.10"
          mkdir -p dist
          
          # Download psycopg2-binary to get libs
          download_binary_libs() {
            local platform=$1
            local pip_platform=$2
            
            echo "Downloading psycopg2-binary libs for $platform..."
            mkdir -p "binary_libs/${platform}"
            pip download "psycopg2-binary==${PSYCOPG2_BINARY_VERSION}" \
              --python-version 38 \
              --platform "$pip_platform" \
              --only-binary=:all: \
              -d "binary_libs/${platform}" \
              --no-deps || true
            
            # Extract libs from downloaded wheel
            for whl in binary_libs/${platform}/*.whl; do
              if [ -f "$whl" ]; then
                echo "Extracting: $whl"
                unzip -o -q "$whl" -d "binary_libs/${platform}/extracted"
                break
              fi
            done
          }
          
          # Download binary libs (manylinux_2_17 works for both CentOS 7 and 8)
          download_binary_libs "linux-x86_64" "manylinux_2_17_x86_64"
          download_binary_libs "linux-aarch64" "manylinux_2_17_aarch64"
          
          # Function to package Linux platform
          package_platform() {
            local artifact_prefix=$1
            local output_name=$2
            local binary_platform=$3
            
            echo "=== Packaging $output_name ==="
            mkdir -p "pkg/${output_name}/psycounvdb"
            mkdir -p "pkg/${output_name}/psycounvdb.libs"
            
            # Extract all wheels for this platform
            for whl in artifacts/${artifact_prefix}-*/*.whl; do
              echo "Extracting: $whl"
              unzip -o -q "$whl" -d "tmp_extract"
              
              # Copy .so files to psycounvdb/
              find tmp_extract/psycounvdb -name "*.so" 2>/dev/null | while read f; do
                cp "$f" "pkg/${output_name}/psycounvdb/"
              done
              
              # Copy Python files (only once)
              if [ ! -f "pkg/${output_name}/psycounvdb/__init__.py" ]; then
                find tmp_extract/psycounvdb -name "*.py" 2>/dev/null | while read f; do
                  cp "$f" "pkg/${output_name}/psycounvdb/"
                done
              fi
              
              rm -rf tmp_extract
            done
            
            # Copy libs from psycopg2-binary
            if [ -d "binary_libs/${binary_platform}/extracted/psycopg2_binary.libs" ]; then
              echo "Copying libs from psycopg2-binary..."
              cp -v binary_libs/${binary_platform}/extracted/psycopg2_binary.libs/* \
                "pkg/${output_name}/psycounvdb.libs/"
            else
              echo "WARNING: psycopg2_binary.libs not found"
            fi
            
            echo "Libs in psycounvdb.libs:"
            ls -la "pkg/${output_name}/psycounvdb.libs/"
            
            # Get the libpq filename from psycopg2-binary
            BINARY_LIBPQ=$(ls "pkg/${output_name}/psycounvdb.libs/" | grep "^libpq-" | head -1)
            echo "Binary libpq: $BINARY_LIBPQ"
            
            # Fix .so files: replace NEEDED entries and set RPATH
            echo "Fixing .so files..."
            for so_file in pkg/${output_name}/psycounvdb/*.so; do
              if [ -f "$so_file" ]; then
                # Get current libpq NEEDED entry
                OUR_LIBPQ=$(patchelf --print-needed "$so_file" 2>/dev/null | grep "^libpq-" || true)
                
                if [ -n "$OUR_LIBPQ" ] && [ -n "$BINARY_LIBPQ" ] && [ "$OUR_LIBPQ" != "$BINARY_LIBPQ" ]; then
                  echo "Replacing $OUR_LIBPQ -> $BINARY_LIBPQ in $(basename $so_file)"
                  patchelf --replace-needed "$OUR_LIBPQ" "$BINARY_LIBPQ" "$so_file" 2>/dev/null || true
                fi
                
                # Set RPATH
                patchelf --set-rpath '$ORIGIN/../psycounvdb.libs' "$so_file" 2>/dev/null || true
                echo "Fixed: $(basename $so_file)"
              fi
            done
            
            # Determine Python version range
            cd "pkg/${output_name}"
            PY_VERSIONS=$(ls psycounvdb/*.so 2>/dev/null | sed -E 's/.*cpython-([0-9]+).*/\1/' | sort -n | uniq)
            PY_MIN=$(echo "$PY_VERSIONS" | head -1)
            PY_MAX=$(echo "$PY_VERSIONS" | tail -1)
            PY_MIN_FMT="${PY_MIN:0:1}.${PY_MIN:1}"
            PY_MAX_FMT="${PY_MAX:0:1}.${PY_MAX:1}"
            
            # Create zip
            ZIP_NAME="psycounvdb-${VERSION}-${output_name}-python${PY_MIN_FMT}~${PY_MAX_FMT}.zip"
            zip -r "../../dist/${ZIP_NAME}" psycounvdb psycounvdb.libs
            cd ../..
            
            echo "Created: dist/${ZIP_NAME}"
            ls -lh "dist/${ZIP_NAME}"
          }
          
          # Package Windows
          package_windows() {
            echo "=== Packaging windows-amd64 ==="
            mkdir -p "pkg/windows-amd64/psycounvdb"
            mkdir -p "pkg/windows-amd64/psycounvdb.libs"
            
            # Extract wheels
            for whl in artifacts/windows-amd64-*/*.whl; do
              echo "Extracting: $whl"
              unzip -o -q "$whl" -d "tmp_extract"
              
              # Copy .pyd files
              find tmp_extract -name "*.pyd" -type f 2>/dev/null | while read f; do
                cp "$f" "pkg/windows-amd64/psycounvdb/"
              done
              
              # Copy Python files (only once)
              if [ ! -f "pkg/windows-amd64/psycounvdb/__init__.py" ]; then
                find tmp_extract/psycounvdb -name "*.py" 2>/dev/null | while read f; do
                  cp "$f" "pkg/windows-amd64/psycounvdb/"
                done
              fi
              
              rm -rf tmp_extract
            done
            
            # Copy DLLs from vcpkg artifact
            if [ -d "artifacts/windows-vcpkg-dlls" ]; then
              find artifacts/windows-vcpkg-dlls -name "*.dll" -type f | while read f; do
                cp "$f" "pkg/windows-amd64/psycounvdb.libs/"
              done
            fi
            
            echo "Files in psycounvdb.libs:"
            ls -la "pkg/windows-amd64/psycounvdb.libs/"
            
            cd "pkg/windows-amd64"
            PY_VERSIONS=$(ls psycounvdb/*.pyd 2>/dev/null | sed -E 's/.*cp([0-9]+).*/\1/' | sort -n | uniq)
            PY_MIN=$(echo "$PY_VERSIONS" | head -1)
            PY_MAX=$(echo "$PY_VERSIONS" | tail -1)
            PY_MIN_FMT="${PY_MIN:0:1}.${PY_MIN:1}"
            PY_MAX_FMT="${PY_MAX:0:1}.${PY_MAX:1}"
            
            ZIP_NAME="psycounvdb-${{ env.VERSION }}-windows-amd64-python${PY_MIN_FMT}~${PY_MAX_FMT}.zip"
            zip -r "../../dist/${ZIP_NAME}" psycounvdb psycounvdb.libs
            cd ../..
            
            echo "Created: dist/${ZIP_NAME}"
            ls -lh "dist/${ZIP_NAME}"
          }
          
          # Package each platform
          package_platform "linux-x86_64" "linux-x86_64" "linux-x86_64"
          package_platform "linux-aarch64" "linux-aarch64" "linux-aarch64"
          package_platform "linux-x86_64-legacy" "linux-x86_64-centos7" "linux-x86_64"
          package_platform "linux-aarch64-legacy" "linux-aarch64-centos7" "linux-aarch64"
          package_windows
          
          echo ""
          echo "=== Generated packages ==="
          ls -lh dist/

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v6
        with:
          name: psycounvdb-all-platforms
          path: dist/*.zip
