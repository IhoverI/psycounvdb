---
name: Build psycounvdb packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: false
        default: '2.9.11'

env:
  PIP_BREAK_SYSTEM_PACKAGES: "1"
  LIBPQ_VERSION: "17.6"
  OPENSSL_VERSION: "3.5.4"
  PACKAGE_NAME: "psycounvdb"
  VERSION: "2.9.11"

jobs:
  linux-x86_64:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-x86_64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}-manylinux_2_28

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_x86_64
          CIBW_ARCHS_LINUX: x86_64
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  linux-aarch64:
    runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        platform: [manylinux]
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313]

    steps:
      - name: Checkout repos
        uses: actions/checkout@v4

      - name: Cache libpq build
        uses: actions/cache@v4
        with:
          path: /tmp/libpq.build
          key: libpq-${{ matrix.platform }}-aarch64-${{ env.LIBPQ_VERSION }}-${{ env.OPENSSL_VERSION }}-manylinux_2_28

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          CIBW_BUILD: ${{matrix.pyver}}-${{matrix.platform}}_aarch64
          CIBW_ARCHS_LINUX: aarch64
          CIBW_BEFORE_ALL_LINUX: ./scripts/build/wheel_linux_before_all.sh
          CIBW_REPAIR_WHEEL_COMMAND: >-
            ./scripts/build/strip_wheel.sh {wheel}
            && auditwheel repair -w {dest_dir} {wheel}
          CIBW_ENVIRONMENT_PASS_LINUX: LIBPQ_VERSION OPENSSL_VERSION
          CIBW_ENVIRONMENT: >-
            PACKAGE_NAME=psycounvdb
            LIBPQ_BUILD_PREFIX=/host/tmp/libpq.build
            PATH="$LIBPQ_BUILD_PREFIX/bin:$PATH"
            LD_LIBRARY_PATH="$LIBPQ_BUILD_PREFIX/lib:$LIBPQ_BUILD_PREFIX/lib64"
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28

      - uses: actions/upload-artifact@v4
        with:
          name: linux-aarch64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  windows-amd64:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        pyver: [cp38, cp39, cp310, cp311, cp312, cp313]

    defaults:
      run:
        shell: bash

    steps:
      - name: Drop spurious libpq in the path
        run: rm -rf c:/tools/php C:/Strawberry/c/bin

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            const path = require('path')
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
            core.addPath(path.join(process.env.VCPKG_INSTALLATION_ROOT, 'installed/x64-windows-release/lib'));
            core.addPath(path.join(process.env.VCPKG_INSTALLATION_ROOT, 'installed/x64-windows-release/bin'));

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
          CIBW_BUILD: ${{matrix.pyver}}-win_amd64
          CIBW_ARCHS_WINDOWS: AMD64
          CIBW_BEFORE_BUILD_WINDOWS: '.\scripts\build\wheel_win32_before_build.bat'
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: >-
            delvewheel repair -w {dest_dir}
            --no-mangle "libiconv-2.dll;libwinpthread-1.dll" {wheel}
          CIBW_ENVIRONMENT_WINDOWS: >-
            PACKAGE_NAME=psycounvdb

      - uses: actions/upload-artifact@v4
        with:
          name: windows-amd64-${{matrix.pyver}}
          path: ./wheelhouse/*.whl

  package:
    runs-on: ubuntu-latest
    needs:
      - linux-x86_64
      - linux-aarch64
      - windows-amd64

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Package by platform
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p dist
          
          # Download psycopg2-binary to get optimized libs
          download_binary_libs() {
            local platform=$1
            local pip_platform=$2
            local version=${3:-2.9.10}
            
            echo "Downloading psycopg2-binary libs for $platform (version $version)..."
            mkdir -p "binary_libs/${platform}"
            pip download "psycopg2-binary==${version}" \
              --python-version 38 \
              --platform "$pip_platform" \
              --only-binary=:all: \
              -d "binary_libs/${platform}" \
              --no-deps || true
            
            # Extract libs from downloaded wheel
            for whl in binary_libs/${platform}/*.whl; do
              if [ -f "$whl" ]; then
                unzip -o -q "$whl" -d "binary_libs/${platform}/extracted"
                break
              fi
            done
          }
          
          # Download binary libs for each platform
          download_binary_libs "linux-x86_64" "manylinux_2_17_x86_64" "2.9.10"
          download_binary_libs "linux-aarch64" "manylinux_2_17_aarch64" "2.9.10"
          download_binary_libs "windows-amd64" "win_amd64" "2.9.9"
          
          # Debug: show what was downloaded for Windows
          echo "=== Windows binary download contents ==="
          ls -la binary_libs/windows-amd64/ 2>/dev/null || echo "No windows binary dir"
          if [ -d "binary_libs/windows-amd64/extracted" ]; then
            find binary_libs/windows-amd64/extracted -type f -name "*.dll" 2>/dev/null
          fi
          
          # Function to extract and package wheels
          package_platform() {
            local platform=$1
            local arch=$2
            local output_name=$3
            local binary_platform=$4
            
            echo "=== Packaging $platform-$arch ==="
            mkdir -p "pkg/${platform}-${arch}/psycounvdb"
            mkdir -p "pkg/${platform}-${arch}/psycounvdb_binary.libs"
            
            # Extract all wheels for this platform
            for whl in artifacts/${platform}-${arch}-*/*.whl; do
              echo "Extracting: $whl"
              unzip -o -q "$whl" -d "tmp_extract"
              
              # Copy .so/.pyd files to psycounvdb/
              find tmp_extract/psycounvdb -name "*.so" -o -name "*.pyd" 2>/dev/null | while read f; do
                cp "$f" "pkg/${platform}-${arch}/psycounvdb/"
              done
              
              # Copy Python files (only once)
              if [ ! -f "pkg/${platform}-${arch}/psycounvdb/__init__.py" ]; then
                find tmp_extract/psycounvdb -name "*.py" 2>/dev/null | while read f; do
                  cp "$f" "pkg/${platform}-${arch}/psycounvdb/"
                done
              fi
              
              rm -rf tmp_extract
            done
            
            # Copy libs from psycopg2-binary (optimized, smaller)
            echo "Looking for libs in binary_libs/${binary_platform}/extracted/"
            ls -la "binary_libs/${binary_platform}/extracted/" 2>/dev/null || echo "Directory not found"
            
            # Try different possible lib directory names
            for libdir in "psycopg2_binary.libs" "psycopg2.libs" "psycopg2_binary-2.9.10.data/scripts/../psycopg2_binary.libs"; do
              if [ -d "binary_libs/${binary_platform}/extracted/${libdir}" ]; then
                echo "Found libs in: ${libdir}"
                cp -v binary_libs/${binary_platform}/extracted/${libdir}/* \
                  "pkg/${platform}-${arch}/psycounvdb_binary.libs/" 2>/dev/null || true
                break
              fi
            done
            
            # Also check for libs directly in psycopg2 or psycopg2_binary directory
            find "binary_libs/${binary_platform}/extracted" -name "*.so*" -type f 2>/dev/null | while read f; do
              if [[ "$f" == *".libs/"* ]]; then
                cp -v "$f" "pkg/${platform}-${arch}/psycounvdb_binary.libs/" 2>/dev/null || true
              fi
            done
            
            echo "Libs copied to psycounvdb_binary.libs:"
            ls -la "pkg/${platform}-${arch}/psycounvdb_binary.libs/" 2>/dev/null || echo "No libs found"
            
            # Determine Python version range
            cd "pkg/${platform}-${arch}"
            PY_VERSIONS=$(ls psycounvdb/*.so psycounvdb/*.pyd 2>/dev/null | sed -E 's/.*cpython-([0-9]+).*/\1/' | sort -n | uniq)
            PY_MIN=$(echo "$PY_VERSIONS" | head -1)
            PY_MAX=$(echo "$PY_VERSIONS" | tail -1)
            PY_MIN_FMT="${PY_MIN:0:1}.${PY_MIN:1}"
            PY_MAX_FMT="${PY_MAX:0:1}.${PY_MAX:1}"
            
            # Create zip
            ZIP_NAME="psycounvdb-${VERSION}-${output_name}-python${PY_MIN_FMT}~${PY_MAX_FMT}.zip"
            zip -r "../../dist/${ZIP_NAME}" psycounvdb psycounvdb_binary.libs
            cd ../..
            
            echo "Created: dist/${ZIP_NAME}"
            ls -lh "dist/${ZIP_NAME}"
          }
          
          # Package Windows
          package_windows() {
            echo "=== Packaging windows-amd64 ==="
            mkdir -p "pkg/windows-amd64/psycounvdb"
            
            # First, get DLLs from psycopg2-binary
            echo "Looking for DLLs in binary_libs/windows-amd64/extracted/"
            ls -laR "binary_libs/windows-amd64/extracted/" 2>/dev/null || echo "Directory not found"
            
            # Find and copy ALL DLLs from psycopg2-binary (search everywhere)
            echo "Searching for all DLLs..."
            find binary_libs/windows-amd64/extracted -name "*.dll" -type f 2>/dev/null | while read f; do
              echo "Copying DLL: $f"
              cp "$f" "pkg/windows-amd64/psycounvdb/"
            done
            
            # Extract our wheels
            for whl in artifacts/windows-amd64-*/*.whl; do
              echo "Extracting: $whl"
              unzip -o -q "$whl" -d "tmp_extract"
              
              # Copy .pyd files
              find tmp_extract/psycounvdb -name "*.pyd" 2>/dev/null | while read f; do
                cp "$f" "pkg/windows-amd64/psycounvdb/"
              done
              
              # Copy Python files (only once)
              if [ ! -f "pkg/windows-amd64/psycounvdb/__init__.py" ]; then
                find tmp_extract/psycounvdb -name "*.py" 2>/dev/null | while read f; do
                  cp "$f" "pkg/windows-amd64/psycounvdb/"
                done
              fi
              
              rm -rf tmp_extract
            done
            
            echo "Files in pkg/windows-amd64/psycounvdb/:"
            ls -la "pkg/windows-amd64/psycounvdb/"
            
            cd "pkg/windows-amd64"
            PY_VERSIONS=$(ls psycounvdb/*.pyd 2>/dev/null | sed -E 's/.*cp([0-9]+).*/\1/' | sort -n | uniq)
            PY_MIN=$(echo "$PY_VERSIONS" | head -1)
            PY_MAX=$(echo "$PY_VERSIONS" | tail -1)
            PY_MIN_FMT="${PY_MIN:0:1}.${PY_MIN:1}"
            PY_MAX_FMT="${PY_MAX:0:1}.${PY_MAX:1}"
            
            ZIP_NAME="psycounvdb-${{ env.VERSION }}-windows-amd64-python${PY_MIN_FMT}~${PY_MAX_FMT}.zip"
            zip -r "../../dist/${ZIP_NAME}" psycounvdb
            cd ../..
            
            echo "Created: dist/${ZIP_NAME}"
            ls -lh "dist/${ZIP_NAME}"
          }
          
          # Package each platform
          package_platform "linux" "x86_64" "linux-x86_64" "linux-x86_64"
          package_platform "linux" "aarch64" "linux-aarch64" "linux-aarch64"
          package_windows
          
          echo ""
          echo "=== Generated packages ==="
          ls -lh dist/

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: psycounvdb-all-platforms
          path: dist/*.zip
